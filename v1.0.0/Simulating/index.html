<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Simulations · ReactionMechanismSimulator.jl</title><meta name="title" content="Simulations · ReactionMechanismSimulator.jl"/><meta property="og:title" content="Simulations · ReactionMechanismSimulator.jl"/><meta property="twitter:title" content="Simulations · ReactionMechanismSimulator.jl"/><meta name="description" content="Documentation for ReactionMechanismSimulator.jl."/><meta property="og:description" content="Documentation for ReactionMechanismSimulator.jl."/><meta property="twitter:description" content="Documentation for ReactionMechanismSimulator.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="ReactionMechanismSimulator.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ReactionMechanismSimulator.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../Installation/">Install Julia</a></li><li><a class="tocitem" href="../Input/">Input</a></li><li class="is-active"><a class="tocitem" href>Simulations</a><ul class="internal"><li><a class="tocitem" href="#Defining-a-Phase"><span>Defining a Phase</span></a></li><li><a class="tocitem" href="#Defining-Initial-Conditions"><span>Defining Initial Conditions</span></a></li><li><a class="tocitem" href="#Defining-an-Interface-object"><span>Defining an Interface object</span></a></li><li><a class="tocitem" href="#Defining-a-Domain"><span>Defining a Domain</span></a></li><li><a class="tocitem" href="#Defining-a-Reactor-object"><span>Defining a Reactor object</span></a></li><li><a class="tocitem" href="#Solving-a-Reactor-object"><span>Solving a Reactor object</span></a></li><li><a class="tocitem" href="#Saving-a-Solution-Object"><span>Saving a Solution Object</span></a></li><li><a class="tocitem" href="#Threaded-Sensitivity-Analysis"><span>Threaded Sensitivity Analysis</span></a></li></ul></li><li><a class="tocitem" href="../Analysis/">Analysis</a></li><li><a class="tocitem" href="../AutomaticMechanismAnalysis/">Automatic Mechanism Analysis</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Simulations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Simulations</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ReactionMechanismGenerator/ReactionMechanismSimulator.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/ReactionMechanismGenerator/ReactionMechanismSimulator.jl/blob/main/docs/src/Simulating.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Simulations"><a class="docs-heading-anchor" href="#Simulations">Simulations</a><a id="Simulations-1"></a><a class="docs-heading-anchor-permalink" href="#Simulations" title="Permalink"></a></h1><h2 id="Defining-a-Phase"><a class="docs-heading-anchor" href="#Defining-a-Phase">Defining a Phase</a><a id="Defining-a-Phase-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-a-Phase" title="Permalink"></a></h2><p>A phase in RMS defines how thermodynamic and kinetic parameters for individual species and reactions are calculated.  For the <code>IdealGas</code> case defining a phase is quite simple:  </p><pre><code class="nohighlight hljs">ig = IdealGas(spcs,rxns,name=&quot;gas&quot;)</code></pre><p>where <code>spcs</code> and <code>rxns</code> are lists of <code>AbstractSpecies</code> and <code>AbstractReaction</code> objects respectively.   For an <code>IdealDiluteSolution</code> it is slightly more complicated because some of these properties (currently  primarily diffusion limitations) can be dependent on the solvent:  </p><pre><code class="nohighlight hljs">solv = Solvent(&quot;octane&quot;,RiedelViscosity(-98.805,3905.5,14.103,-2.5112e-5,2.0))
liq = IdealDiluteSolution(spcs,rxns,solv;name=&quot;phase&quot;,diffusionlimited=true)</code></pre><h2 id="Defining-Initial-Conditions"><a class="docs-heading-anchor" href="#Defining-Initial-Conditions">Defining Initial Conditions</a><a id="Defining-Initial-Conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-Initial-Conditions" title="Permalink"></a></h2><p>Initial conditions for the simulation are defined within a dictionary in SI units.  The keys <code>&quot;T&quot;</code>,<code>&quot;P&quot;</code> and <code>&quot;V&quot;</code> correspond to thermodynamic values (<code>&quot;V&quot;</code> being the extensive volume) while species names correspond to numbers of moles (extensive).  </p><p>For example, since the initial <code>V</code> can be calculated implicitly a valid <code>IdealGas</code> initial condition might be:  </p><pre><code class="nohighlight hljs">Dict([&quot;T&quot;=&gt;1000.0,&quot;P&quot;=&gt;1e5,&quot;H2&quot;=&gt;0.67,&quot;O2&quot;=&gt;0.33])</code></pre><p>In the case of an <code>IdealDiluteSolution</code> where pressure is assumed to not affect the thermodynamic state it might look more like:  </p><pre><code class="nohighlight hljs">Dict([&quot;T&quot;=&gt;450.0,&quot;V&quot;=&gt;1.0e-6,&quot;octane&quot;=&gt;6.154e-3,&quot;oxygen&quot;=&gt;4.953e-6])</code></pre><h2 id="Defining-an-Interface-object"><a class="docs-heading-anchor" href="#Defining-an-Interface-object">Defining an Interface object</a><a id="Defining-an-Interface-object-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-an-Interface-object" title="Permalink"></a></h2><p>In many cases you will have connections between multiple domains in your system or between one domain and something outside the system. In these cases you need to define interfaces.</p><p>Example Inlet:</p><pre><code class="nohighlight hljs">Flow(t::Float64) = 10.0
inletdict= Dict([&quot;T&quot;=&gt;800.0,&quot;P&quot;=&gt;10.0e5,&quot;O2&quot;=&gt;0.21, &quot;N2&quot;=&gt;0.79])
inlet = Inlet(domain,inletdict,Flow</code></pre><p>Example Reactive Interface:</p><pre><code class="nohighlight hljs">inter,pinter = ReactiveInternalInterfaceConstantTPhi(domainliq,domaincat,interfacerxns,Tinter,areainter)</code></pre><h2 id="Defining-a-Domain"><a class="docs-heading-anchor" href="#Defining-a-Domain">Defining a Domain</a><a id="Defining-a-Domain-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-a-Domain" title="Permalink"></a></h2><p>A domain in RMS is a homogeneous volume that contains a single phase.  The <code>AbstractDomain</code> object defines how the thermodynamics of the volume evolve with respect to time.  For example in a <code>ConstantTPDomain</code> the temperature and pressure are defined in the domain object and held constant over the simulation and the volume is integrated for while in a <code>ConstantVDomain</code> (a constant V adiabatic reactor) the volume is kept constant and the temperature is integrated for.</p><p>When constructing a Domain object constant concentration species can be defined (list of species names).   During integration the derivatives with respect to time of these species will be kept at zero.  </p><p><code>IdealDiluteSolution</code> example:  </p><pre><code class="nohighlight hljs">domain,y0,p = ConstantTVDomain(phase=liq,initialconds=initialconds,constantspecies=[&quot;oxygen&quot;])</code></pre><p><code>IdealGas</code> example:  </p><pre><code class="nohighlight hljs">domain,y0,p = ConstantTPDomain(phase=ig,initialconds=initialconds)</code></pre><h2 id="Defining-a-Reactor-object"><a class="docs-heading-anchor" href="#Defining-a-Reactor-object">Defining a Reactor object</a><a id="Defining-a-Reactor-object-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-a-Reactor-object" title="Permalink"></a></h2><p>The Reactor object exists primarily to automatically sets up the ODEProblem object for you to solve.   For single domain reactors it takes the domain, the initial condition vector returned when constructing the domain, a time interval and an array of any interface objects and returns a Reactor object. If your system has multiple domains you need to pass the domains, initialconditions time interval, array of interfaces and parameters with the domains, associated initial conditions and associated parameters as tuples in consistent order from domains to interfaces.</p><p>Example single domain:  </p><pre><code class="nohighlight hljs">react = Reactor(domain,y0,(0.0,150.1),interfaces,p=p)</code></pre><p>Example multiple domains:</p><pre><code class="nohighlight hljs">react,y0,p = Reactor((domainliq,domaincat), (y0liq,y0cat), (0.0, 1.0e5), [inter], (pliq,pcat,pinter))</code></pre><h2 id="Solving-a-Reactor-object"><a class="docs-heading-anchor" href="#Solving-a-Reactor-object">Solving a Reactor object</a><a id="Solving-a-Reactor-object-1"></a><a class="docs-heading-anchor-permalink" href="#Solving-a-Reactor-object" title="Permalink"></a></h2><p>RMS purposefully exposes the solver interface provide users with all the options available from Julia&#39;s DifferentialEquations package.  The ODEProblem object is a field of the Reactor object <code>react.ode</code> and can be solved as the user desires. A recommended solver choice is stored in <code>react.recommendedsolver</code>. User can also specify their own choice of solver.</p><p>Forward sensitivity analysis can also be requested on the Reactor object by setting <code>forwardsensitivities=true</code>. Note that adjoint and threaded sensitivity analyses are usually much faster. Adjoint sensitivity analysis can be done as postprocessing analysis after the simulation is complete without a need to set <code>forwardsensitivities=true</code> during the simulation (this are discussed in the Analysis section). Threaded sensitivity analysis will be discussed in the next section.</p><p>Example:</p><pre><code class="nohighlight hljs">sol = solve(react.ode,react.recommendedsolver,abstol=1e-20,reltol=1e-12)</code></pre><pre><code class="nohighlight hljs">sol = solve(react.ode,CVODE_BDF(),abstol=1e-20,reltol=1e-12;forwardsensitivities=true)</code></pre><p>In general CVODE_BDF tends to work well on these problems.  </p><h2 id="Saving-a-Solution-Object"><a class="docs-heading-anchor" href="#Saving-a-Solution-Object">Saving a Solution Object</a><a id="Saving-a-Solution-Object-1"></a><a class="docs-heading-anchor-permalink" href="#Saving-a-Solution-Object" title="Permalink"></a></h2><p>The user may wish to save useful objects from above:</p><pre><code class="nohighlight hljs">bsol = Simulation(sol, domain)</code></pre><p>Saving the data to a Julia data structure (<a href="https://github.com/JuliaIO/JLD2.jl">JLD2</a>) seems to work well. Once the <code>JLD2</code> package has been downloaded, data can be saved using the following commands:</p><pre><code class="nohighlight hljs">using JLD2, FileIO
save(&quot;&lt;file_name&gt;.jld2&quot;, &quot;bsol_saved&quot;, bsol)</code></pre><p>The data can be read back into Julia as a dictionary, and the desired data can be accessed using its corresponding key:</p><pre><code class="nohighlight hljs">d = load(&quot;&lt;file_name&gt;.jld2&quot;)
bsol_loaded = d[&quot;bsol_saved&quot;]</code></pre><p>Since the data is saved in HDF5 format, it can also be read into Python as follows:</p><pre><code class="nohighlight hljs">import h5py
f = h5py.File(&quot;&lt;file_name&quot;, &quot;r&quot;)</code></pre><h2 id="Threaded-Sensitivity-Analysis"><a class="docs-heading-anchor" href="#Threaded-Sensitivity-Analysis">Threaded Sensitivity Analysis</a><a id="Threaded-Sensitivity-Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Threaded-Sensitivity-Analysis" title="Permalink"></a></h2><p>Instead of solving all of the sensitivity equations at once as is done in raw Forward sensitivity analysis we can first solve the equations without sensitivity analysis alone. With an interpolatable solution to the original equations the sensitivities associated with each parameter are decoupled from the sensitivities of every other parameter and can be solved independently. Solving these groups of equations sequentially is often significantly faster than solving the equations together. However, by parallelizing the solution of these equations using multithreading it is possible to achieve dramatic speed ups. This approach is not always competitive with adjoint sensitivities as the adjoint approach requires solution of a much smaller system of equations, however, in practice this approach is often more robust especially for large systems.</p><p>In order to take advantage of multithreading you must set the number of threads before launching Julia see the documentation &lt;a href=&quot;https://docs.julialang.org/en/v1/manual/multi-threading/&quot;&gt;here&lt;/a&gt;. We provide two methods for this algorithm. The first method below calculates the sensitivities of all variables to all parameters and provides a solution object that can be used in the same way as the output of a solve on a Reactor with forwardsensitivities=true:</p><pre><code class="nohighlight hljs">using Base.Threads
nthreads = Threads.nthreads()
println(&quot;Using $nthreads threads&quot;)

sol = threadedsensitivities(react; odesolver=react.recommendedsolver,senssolver=react.recommendedsolver,
        odekwargs=Dict([:abstol=&gt;1e-20,:reltol=&gt;1e-6]),senskwargs=Dict([:abstol=&gt;1e-6,:reltol=&gt;1e-3]))</code></pre><p>We also provide a second method shown below. This variant allows the user to specify the indices of the parameters to calculate sensitivities for. However, because not all of the sensitivies are calculated the results cannot be formatted into a solution object that can be fed into a <code>Simulation</code> or <code>SystemSimulation</code> object. So instead a dictionary mapping the parameter index to an ODE solution of the associated sensitivity equations is provided. Note  that parameters are structured starting in species order with parameters corresponding to the Gibbs free energy of each species and continuing in reaction order with a parameter corresponding to each rate coefficient. The output solution objects are in species + thermodynamic variable order and are the raw sensitivities with no normalization.</p><pre><code class="nohighlight hljs">using Base.Threads
nthreads = Threads.nthreads()
println(&quot;Using $nthreads threads&quot;)

soldict = threadedsensitivities(react,indices; odesolver=react.recommendedsolver,senssolver=react.recommendedsolver,
        odekwargs=Dict([:abstol=&gt;1e-20,:reltol=&gt;1e-6]),senskwargs=Dict([:abstol=&gt;1e-6,:reltol=&gt;1e-3]))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Input/">« Input</a><a class="docs-footer-nextpage" href="../Analysis/">Analysis »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Monday 26 February 2024 04:58">Monday 26 February 2024</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
